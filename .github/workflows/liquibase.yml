name: Liquibase â†’ Supabase

on:
  workflow_dispatch: {}
  push:
    branches: [ "dev" ]
    paths: [ "db/changelog/**" ]

jobs:
  migrate:
    runs-on: ubuntu-latest
    env:
      # Byt till ditt projekt (DEV eller TEST)
      DB_URL: jdbc:postgresql://db.kbqhuywtelqmuyhofjlp.supabase.co:5432/postgres?sslmode=require
      DB_USER: postgres
      CHANGELOG: db/changelog/master.yaml
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Show pending SQL (dry run)
        uses: docker://liquibase/liquibase:4.33
        with:
          args: >
            --url=${{ env.DB_URL }}
            --username=${{ env.DB_USER }}
            --password=${{ secrets.DB_PASSWORD }}
            --changelog-file=${{ env.CHANGELOG }}
            updateSQL

      - name: Status
        uses: docker://liquibase/liquibase:4.33
        with:
          args: >
            --url=${{ env.DB_URL }}
            --username=${{ env.DB_USER }}
            --password=${{ secrets.DB_PASSWORD }}
            --changelog-file=${{ env.CHANGELOG }}
            status

      - name: Apply changes (update)
        uses: docker://liquibase/liquibase:4.33
        with:
          args: >
            --url=${{ env.DB_URL }}
            --username=${{ env.DB_USER }}
            --password=${{ secrets.DB_PASSWORD }}
            --changelog-file=${{ env.CHANGELOG }}
            update
